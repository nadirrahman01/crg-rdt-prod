<!-- index.html -->
<!-- NOTE: Only additions made (no removals). Adds target price + stats boxes under the price chart panel,
     and adds CRG Rating selector with an info popover (Equity Research only).
     AND adds: tool guidance info box + form novalidate.
     AND adds: Email to CRG Research button (prefilled mailto; user attaches doc manually).
     AND adds: Phone country code selector + auto hyphen formatting (CC-XXXXXXXX...) -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CRG - Research Documentation Tool</title>
  <link rel="stylesheet" href="assets/styles.css">

  <!-- Chart.js (for price chart) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="container">

    <header class="hero">
      <h1 class="hero-title">CRG - Research Documentation Tool</h1>
    </header>

    <form id="researchForm" novalidate>
      <!-- Note Type -->
      <label for="noteType">Type of Note</label>
      <select id="noteType" required>
        <option value="">Select note type...</option>
        <option value="General Note">General Note</option>
        <option value="Equity Research">Equity Research</option>
        <option value="Macro Research">Macro Research</option>
        <option value="Fixed Income Research">Fixed Income Research</option>
        <option value="Commodity Insights">Commodity Insights</option>
      </select>

      <!-- NEW: Tool guidance -->
      <div class="tool-info">
        <div class="tool-info-title">How to use this tool</div>
        <div class="tool-info-text">
          Fill out the note fields, then click <strong>Generate Word Document</strong>.
          For <strong>Equity Research</strong>, the <strong>Ticker / Company</strong> field is optional — if a ticker isn’t available, leave it blank.
          This tool pulls price data using <strong>Stooq symbols</strong>: for US equities use <strong>MSFT.US</strong> (or just <strong>MSFT</strong>), and for UK/LSE equities use the <strong>.UK</strong> suffix, e.g. <strong>VOD.UK</strong>, <strong>BP.UK</strong>, <strong>HSBA.UK</strong>.
          If you’re unsure, use Stooq’s search to confirm the symbol:
          <a href="https://stooq.com/" target="_blank" rel="noopener noreferrer">stooq.com</a>
          (type the company name/ticker in their search box).
          If you’ve built a model, it’s often easiest to upload <strong>screenshots of key model tabs</strong> in the <strong>Upload Images / Graphs</strong> section so the output note is auditable.
        </div>
      </div>
      <!-- /NEW -->

      <!-- Title -->
      <label for="title">Title</label>
      <input type="text" id="title" required placeholder="Enter research title...">

      <!-- Topic -->
      <label for="topic">Topic</label>
      <input type="text" id="topic" required placeholder="Enter topic...">

      <!-- Primary Author -->
      <label for="authorLastName">Primary Author — Last Name</label>
      <input type="text" id="authorLastName" required placeholder="e.g., Rahman">

      <label for="authorFirstName">Primary Author — First Name</label>
      <input type="text" id="authorFirstName" required placeholder="e.g., Nadir">

      <label for="authorPhone">Primary Author — Phone <span class="panel-muted">(Optional)</span></label>

      <!-- NEW: Country code selector (keeps existing authorPhone input) -->
      <div class="phone-row">
        <select id="authorCountryCode" class="country-code" aria-label="Primary author country code">
          <option value="44" selected>+44 (UK)</option>
          <option value="1">+1 (US/CA)</option>
          <option value="39">+39 (IT)</option>
          <option value="353">+353 (IE)</option>
          <option value="971">+971 (UAE)</option>
          <option value="966">+966 (KSA)</option>
          <option value="92">+92 (PK)</option>
          <option value="91">+91 (IN)</option>
          <option value="880">+880 (BD)</option>
        </select>
      </div>
      <!-- /NEW -->

      <!-- Existing input kept; ONLY added attributes -->
      <input type="text" id="authorPhone" required placeholder="e.g., 44-7398344190" inputmode="numeric" autocomplete="tel">

      <!-- Co-Authors Section -->
      <div id="coAuthorsSection" class="panel">
        <div class="panel-head">
          <div class="panel-title">
            Co-Authors <span class="panel-muted">(Optional)</span>
          </div>
          <button type="button" id="addCoAuthor" class="btn btn-secondary">+ Add Co-Author</button>
        </div>

        <div id="coAuthorsList"></div>
      </div>

      <!-- Equity Research: Model & Valuation Attachments -->
      <div id="equitySection" class="equity-section" style="display:none;">
        <div class="equity-header">
          <div class="equity-title">Equity Research — Model & Valuation</div>
          <div class="equity-subtitle">
            Attach your DCF / Excel model and capture assumptions so the note is auditable.
          </div>
        </div>

        <label for="ticker">Ticker / Company <span class="panel-muted">(Optional)</span></label>
        <input type="text" id="ticker" placeholder="e.g., MSFT.US (US) or VOD.UK (UK/LSE)">

        <!-- NEW: CRG Rating (Equity Research) -->
        <div class="rating-row">
          <label for="crgRating" class="rating-label">
            CRG Rating
            <span class="info-badge" tabindex="0" aria-label="Rating definitions">i</span>
               <span class="info-pop">
                 Outperform (O): expected to materially outperform the sector average over a 12-month horizon.<br><br>
                 Sector Perform (SP): expected to perform broadly in line with the sector average over a 12-month horizon.<br><br>
                 Underperform (U): expected to materially underperform the sector average over a 12-month horizon.<br><br>
                 Restricted (R): assigned where CRG precludes the expression of an investment view due to Shariah considerations or ethical constraints. This includes companies whose activities, capital structure, or revenue mix are not aligned with Shariah-compliant or responsible investment principles.<br><br>
                 Not Rated (NR): no formal rating has been assigned. This may reflect limited data availability, early-stage analysis, insufficient conviction, or the fact that the research is intended to be exploratory or thematic rather than a security-specific investment view.
               </span>
          </label>

          <select id="crgRating" class="crg-rating-select">
            <option value="" selected>Select rating...</option>
            <option value="Outperform (O)">Outperform (O)</option>
            <option value="Sector Perform (SP)">Sector Perform (SP)</option>
            <option value="Underperform (U)">Underperform (U)</option>
            <option value="Restricted (R)">Restricted (R)</option>
            <option value="Not Rated (NR)">Not Rated (NR)</option>
          </select>
        </div>
        <!-- /NEW -->

        <!-- Price Chart Panel (existing) -->
        <div class="chart-panel">
          <div class="chart-head">
            <div class="chart-title">Price Chart</div>
            <div class="chart-actions">
              <select id="chartRange" class="chart-range">
                <option value="6mo" selected>6M</option>
                <option value="1y">1Y</option>
                <option value="2y">2Y</option>
                <option value="5y">5Y</option>
              </select>
              <button type="button" id="fetchPriceChart" class="btn btn-secondary">Fetch chart</button>
            </div>
          </div>

          <div id="chartStatus" class="help-text" style="margin-top: 6px;"></div>

          <div class="chart-wrap">
            <canvas id="priceChart" height="140"></canvas>
          </div>

          <!-- NEW: Target price + stats -->
          <label for="targetPrice" style="margin-top: 14px;">Target Price <span class="panel-muted">(Optional)</span></label>
          <input type="text" id="targetPrice" placeholder="e.g., 520">

          <div class="metrics-grid">
            <div class="metric-card">
              <div class="metric-label">Current Price</div>
              <div class="metric-value" id="currentPrice">—</div>
            </div>

            <div class="metric-card">
              <div class="metric-label">Volatility (ann.)</div>
              <div class="metric-value" id="realisedVol">—</div>
            </div>

            <div class="metric-card">
              <div class="metric-label">Return (range)</div>
              <div class="metric-value" id="rangeReturn">—</div>
            </div>

            <div class="metric-card">
              <div class="metric-label">Upside to Target</div>
              <div class="metric-value" id="upsideToTarget">—</div>
            </div>
          </div>
          <!-- /NEW -->
        </div>

        <label for="modelFiles">Upload Model Files (Excel / PDF) <span class="panel-muted">(Optional)</span></label>
        <p class="help-text"><em>Tip: Upload the Excel model (.xlsx/.xlsm) and any exported summary tabs as PDF if you have them.</em></p>
        <input type="file" id="modelFiles" multiple accept=".xlsx,.xlsm,.xls,.csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel,application/pdf">

        <label for="modelLink">Model Link (Drive / SharePoint) <span class="panel-muted">(Optional)</span></label>
        <input type="text" id="modelLink" placeholder="Paste a share link to the model">

        <label for="valuationSummary">Valuation Summary <span class="panel-muted">(Optional)</span></label>
        <textarea id="valuationSummary" rows="6" placeholder="Example: Base-case FV per share, current price, implied upside/downside, and 2–3 lines on the main driver(s)."></textarea>

        <label for="keyAssumptions">Key Assumptions <span class="panel-muted">(Optional)</span></label>
        <textarea id="keyAssumptions" rows="7" placeholder="Example:
WACC: 8.5%
Terminal growth: 2.0%
Revenue CAGR (5y): 7%
EBIT margin (exit): 28%
Tax rate: 19%
Net debt: £X
Shares: X"></textarea>

        <label for="scenarioNotes">Scenario / Sensitivity Notes <span class="panel-muted">(Optional)</span></label>
        <textarea id="scenarioNotes" rows="5" placeholder="Example: What breaks the thesis? What is the bear/base/bull driver? Any sensitivity highlights (WACC / g / margin)?"></textarea>
      </div>

      <!-- Key Takeaways -->
      <label for="keyTakeaways">Key Takeaways</label>
      <textarea id="keyTakeaways" rows="6" required placeholder="Enter key takeaways (use bullet points with - or *)..."></textarea>

      <!-- Analysis and Commentary -->
      <label for="analysis">Analysis and Commentary</label>
      <textarea id="analysis" rows="8" required placeholder="Enter your analysis and commentary..."></textarea>

      <!-- Additional Content -->
      <label for="content">Additional Content <span class="panel-muted">(Optional)</span></label>
      <textarea id="content" rows="10" placeholder="Enter any additional detailed content..."></textarea>

      <!-- The Cordoba View -->
      <label for="cordobaView">The Cordoba View <span class="panel-muted">(Optional)</span></label>
      <textarea id="cordobaView" rows="6" placeholder="Enter Cordoba's perspective and recommendations..."></textarea>

      <!-- Image Upload -->
      <label for="imageUpload">Upload Images / Graphs <span class="panel-muted">(Optional)</span></label>
      <p class="help-text">
        <em>Note: The filename will be used as the figure caption in the document. Name your files accordingly.</em>
      </p>
      <input type="file" id="imageUpload" multiple accept="image/*">

      <!-- NEW: Button row (keeps original submit button; adds Email button) -->
      <div class="form-actions">
        <button type="submit" class="btn btn-primary">Generate Word Document</button>
        <button type="button" id="emailToCrgBtn" class="btn btn-secondary">Email to CRG Research</button>
      </div>
      <!-- /NEW -->

      <!-- NEW: small helper line (optional) -->
      <div class="help-text" style="margin-top: 10px;">
        <em>Email opens prefilled — attach the downloaded .docx before sending.</em>
      </div>
      <!-- /NEW -->

    </form>

    <div id="message" class="message"></div>

  </div>

  <!-- External Libraries -->
  <script src="https://unpkg.com/docx@7.8.2/build/index.js"></script>
  <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <!-- Your JavaScript -->
  <script src="assets/app.js"></script>
</body>
</html>
